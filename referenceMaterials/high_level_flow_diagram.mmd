graph TD
    %% Start of Process
    Start([Document Upload]) --> Ingestion[4.1 Ingestion Guard]
    
    subgraph Layer_1_Ingestion [Ingestion & Risk Assessment]
        Ingestion --> TextCheck{Text Layer Integrity Check}
        TextCheck -- Reliability/Entropy Score --> Routing[4.2 Routing Engine]
    end

    subgraph Layer_2_Routing [Parser Selection]
        Routing --> Decision{Select Parser Path}
        Decision -- High Confidence / Digital --> DetParser[4.3 Deterministic Parser]
        Decision -- Low Confidence / Scanned --> VisionParser[4.4 Vision Parser]
    end

    subgraph Layer_3_Extraction [Hybrid Parsing]
        DetParser --> SpanRepair[Kerning & Span Repair]
        SpanRepair --> VectorInf[Vector-Based Inference]
        VectorInf --> DetAbortCheck{Abort Triggered?}
        
        %% Abort Semantics
        DetAbortCheck -- "Yes (Missing Headers/Conflicting Totals)" --> VisionParser
        DetAbortCheck -- No --> Validation[4.5 Validation Engine]
        
        VisionParser --> VisionNorm[Normalize to Internal Schema]
        VisionNorm --> Validation
    end

    subgraph Layer_4_Validation [Automated Quality Control]
        Validation --> MathAudit{Arithmetic & Semantic Checks}
        MathAudit -- Passed --> ConfScore[Compute Document Confidence]
        MathAudit -- Failed --> HITL[4.6 Human Review Interface]
    end

    subgraph Layer_5_Review [Maker-Checker Model]
        ConfScore --> Threshold{Confidence Threshold}
        Threshold -- High (Phase 3 Auto-Approve) --> Approved([Final Approved Data])
        Threshold -- Low/Medium --> HITL
        
        HITL --> ReviewerAction{Reviewer Action}
        ReviewerAction -- Approve/Correct --> Approved
        ReviewerAction -- Reject --> Rejected([Document Rejected])
    end

    %% Documentation Links
    classDef technical fill:#f9f,stroke:#333,stroke-width:2px;
    class Ingestion,Routing,DetParser,VisionParser,Validation,HITL technical;